<!doctype html>
<html>
<head>
<title>FolxChat</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<link rel="stylesheet" type="text/css" href="/css/style.css"/>

<textarea id="server_public" style="display:none">
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAhBAq0RrhGRYESn5F2GFQ
OjPc3oEmoyUrqOwBDD40XR3H7l1JJou2x66i44NoszmY0TnCfgoK2bjKvPvZRyVb
RTe++YVDPnuG2mKvdRWbJw4l+O16TBe53wxRu2XNXpBte9qAPUP2BgAYCV6i4uqV
c8YUv3e55F/xM2Xtgt/beEx72qZ/10d9K4GRcD4wNRfs3l8wbq/VYwaHwc5nW9hw
suT47RIbyx/GRptS3tJiajfohaaWzoYRCSELFp0z9dLkxIe253BJFGuee+f3+LAM
EN6dbPow0MuEpN8aTmjDReMMTjzaq96GOXq10dEa8ScnFevP89ACgoIfl9AKVaGY
twIDAQAB
-----END PUBLIC KEY-----
</textarea>
<textarea id="client_public" style="display:none">
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1s+mb8QRH8e5PyLigbwi
Bqe3lsOOOZ2LSKk6+NYPx3sn6uAeAmjhJLpHSzeTzg+lcvzd0vM+9EWCQH88wspU
BsxtTanpv2yPYY2jg+NbYuLGXqEtkfHbW3PgywCxqHsci8harHEVXiSa3hMaBh+7
4TmsznV16J+XDNbdyT+3vwnOmrejMZwlf0i1t327L6NzmwVkMfVAlGliVfq2pBNe
MHkwKg6BAxT+0FX1u2oCUvegK2Gxe7gYIF/EpVISZ3XwSURySQcv7eNgFpnj48Ct
V4wJhcdP2p59fHW8574+SR68HK7/ViPB1i691vexcUiQdhFPQOJ4X+IQBLKnV5jv
jwIDAQAB
-----END PUBLIC KEY-----
</textarea>
<textarea id="client_private" style="display:none">
-----BEGIN PRIVATE KEY-----
MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQDWz6ZvxBEfx7k/
IuKBvCIGp7eWw445nYtIqTr41g/Heyfq4B4CaOEkukdLN5POD6Vy/N3S8z70RYJA
fzzCylQGzG1Nqem/bI9hjaOD41ti4sZeoS2R8dtbc+DLALGoexyLyFqscRVeJJre
ExoGH7vhOazOdXXon5cM1t3JP7e/Cc6at6MxnCV/SLW3fbsvo3ObBWQx9UCUaWJV
+rakE14weTAqDoEDFP7QVfW7agJS96ArYbF7uBggX8SlUhJndfBJRHJJBy/t42AW
mePjwK1XjAmFx0/ann18dbznvj5JHrwcrv9WI8HWLr3W97FxSJB2EU9A4nhf4hAE
sqdXmO+PAgMBAAECggEAaxUspP6agrsvb3fWblH4rFSjQnbNyY7txhUGntEnIIwW
RBHhI9Zglcx+idJ0zf4ivgWsFuLHeUHFQp2rDneKF7GEs3iGW7SkbT8MSkzmW48s
0DOM4fotHZPQdaIs7g4hFtWTze65dirNQPNIv9DF+eqkaG9JjeMwi2f5O7+Vu5cg
Gj8E/ZppMexHQprzWBzdhwlstnGscWSt+TUoR3mPtaz/ebACMPI2HmKsH9qOF8xw
NsyKzf0zuqKwEfHKDDf+Te66tW2zLIoN58ED7wHGloGJayBVhLJP96aF2VrCet2a
wxdZ9x8SLxfQTZhcnmwYEt8Q0W0VZOs3ElGLouDKsQKBgQDvkcPbKGzehoqbM+Im
Xw7c4Bs+/jNyX6JuvU04jg9rNIIq1PjToMSYmPj6N3MzMdl2+IfyIlgBR3fIcHBV
sIMOAeF9IFjStM8y3fjm/Gb8hNOIrXhQcDSNSRWJ7OA6XfqEArKOt+TH4xgqraPT
+N8rUYu49SYCBJPdb+g2iWbQswKBgQDlizFAoEQlWlXgWU7GHDIQA/gscZBakhwq
GqK630peh9SwvvPDqXYQ7N5djfkdAAfEBuqZCvwO0xayjzsxOCG1FO5Ch5o4mI7S
O1k6lohlZGfLM+mgg7Ghw2V8BwoeA9771nSCbvCvZa5Qi4G0IzK6S8le0EYiHs6o
9FpfF8mbtQKBgDDM+p6cH4E82uM+sGSsnHR12lb8pTI5NPdl7GMG3TEzYwiilYVW
jHWhQ6aEwRy+nNPVUKwMPu0Tx9y2ustZx3iE/Y/llPJnDoYIHXnAFKJ/1C9VVtrb
4HifWJnd/Ncm6a8WdZUI9LubEQMwl9zIJ33FgLbOiU2D7TMAZsclOiJtAoGAPuwq
AyorpAWgVtCEbIAcJRHBfQVgacN1nwEQLKO68jDP1+dwUOlqKPeVeRXK/O0eM9kl
g/Bj6fhpV2c19acKbmYfbfNYDj2boPuN2Sacmxar8SL43vxavBog/p+7YUD0ZhqC
c6LPrXT1FLU5R9UCOdk+iRQUtZO2WNAq2bhelqUCgYA5LjlCmpimk2zTsemVzgUs
zaN1mbuGxAmejuKhVvntYVlC+V9El/iiV+OR1VvnQxJBpMKAQmX+0jnVUsrtkTGQ
/Y4c43i/VVDWGLpPRlRLg8R+PIMMh4eT149EJJlvfUuuFbMWGOqdrWVU8jauv4bZ
S0NoTtJxIJQbVwe4ZyycMQ==
-----END PRIVATE KEY-----
</textarea>

<script src="/js/encoding.js"></script>
<script src="/js/encoding-indexes.js"></script>
<script src="/js/converter-wrapper.js"></script>
<script src="/js/rsa-wrapper.js"></script>
<script src="/js/aes-wrapper.js"></script>
<script src="/js/sha-wrapper.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.2.0/socket.io.js" integrity="sha256-FdJmJjvYZDWGa7+g9T9z68ylBWPK06W67sa/KwCDBTI=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.js" integrity="sha256-MCmDSoIMecFUw3f1LicZ/D/yonYAoHrgiep/3pCH9rw=" crossorigin="anonymous"></script>

<script>

	function time(){
        date = new Date;
        hour = date.getHours();
        minute = date.getMinutes();
        if(hour < 10){
          hour = "0" + hour;
        }
        if(minute < 10){
          minute = "0" + minute;
        }
        return "["+hour+":"+minute+"]";
    }

	const socket = io();
	let server_aesKey;
	let other_client_aesKey;

	$(document).ready(function() {
		var name = prompt('請輸入暱稱', 'guest');

		if (name == '' || name == null) {
			name = 'guest';
		}

		socket.emit('add user', name);

		socket.on('add user', function(data) {
			appendMessage(data.username + ' 已加入');
		});

		socket.on('user left', function(data) {
			appendMessage(data.username + ' 已離開');
		});

		socket.on('chat message', function(data) {
			console.log(data.username + ' : ' + data.msg);
			let send_hash = data.hash;
			//appendMessage(data.username + ' : ' + data.msg); //demo
			rsaWrapper.privateDecrypt(document.getElementById('client_private').value, data.c_key).then(function(client_aesKey) {
				rsaWrapper.privateDecrypt(document.getElementById('client_private').value, data.s_key).then(function(server_aesKey) {
					aesWrapper.decryptMessage(server_aesKey, data.msg).then(function(s_decrypted) {
						aesWrapper.decryptMessage(client_aesKey, s_decrypted).then(function(decrypted) {
							shaWrapper.sha256(decrypted).then(function(hash) {
								if (hash != send_hash) {
									appendMessage(time() + ' ' + data.username + ' : ' + decrypted + ' < message was altered ! >');
								}
								else {
									appendMessage(time() + ' ' + data.username + ' : ' + decrypted);
								}
							});
						});
					});
				});
			});
		});

		$('#send').click(function() {
			var text = $('#m').val();
			if (text == '')
				return;
			let client_aesKey = aesWrapper.generateKey();
			rsaWrapper.publicEncrypt(document.getElementById('server_public').value, client_aesKey).then(function(encryptedAesKey) {
				shaWrapper.sha256(text).then(function(hash) {
					aesWrapper.encryptMessage(client_aesKey, text).then(function(encrypted) {
						socket.emit('chat message', {
							enc: encrypted,
							hash: hash,
							key: encryptedAesKey
						});
					});
				});
			});
			
			
			$('#m').val('');
			return false;
		});

		$('#m').keydown(function(event) {
			if (event.which == 13) {
				$('#send').click();
			}
		});

		function appendMessage(msg){
			$('#messages').append($('<li>').text(msg));
			var message = document.getElementById('message_block');
			message.scrollTop = message.scrollHeight;
		}
	}); 

</script> 

</head>
<body oncontextmenu="return false">
	<div id="message_block">
		<ul id="messages"></ul>
	</div>
	<input id="m" autocomplete="off"/>
	<button id="send">Send</button>
</body>
</html>